name: æ‰¹é‡åŒæ­¥ (Batch Sync)

on:
  schedule:
    - cron: "0 0 1,15 * *"
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ (è·³è¿‡æ‘˜è¦æ¯”å¯¹)'
        required: false
        type: boolean
        default: false

env:
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}

jobs:
  batch-sync:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—‘ï¸ æ¸…ç†ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          build-mount-path: '/var/lib/docker/'

      - name: é‡å¯ Docker æœåŠ¡
        run: sudo service docker restart

      - name: Checkout Code
        uses: actions/checkout@v3

      - name: ç™»å½•é˜¿é‡Œäº‘ ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: ç™»å½• DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: ğŸ“¦ æ‰¹é‡å¤„ç†é•œåƒ
        run: |
          if [ ! -f "images.txt" ]; then
            echo "âŒ images.txt ä¸å­˜åœ¨ã€‚"
            exit 0
          fi

          echo "ğŸ“‹ å¼€å§‹å¤„ç†..."
          
          while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | xargs)
            [[ -z "$line" || "$line" =~ ^# ]] && continue

            echo "----------------------------------------"
            echo "ğŸ”„ æŒ‡ä»¤: $line"

            # 1. è§£æå‚æ•°
            PLATFORM_ARG=""
            SKOPEO_OS="linux"
            SKOPEO_ARCH="amd64"
            
            if [[ "$line" == *"--platform"* ]]; then
              PLATFORM_VAL=$(echo "$line" | grep -oP '(?<=--platform[ =])\S+')
              if [ -n "$PLATFORM_VAL" ]; then
                 PLATFORM_ARG="--platform $PLATFORM_VAL"
                 echo "âš™ï¸ æ¶æ„: $PLATFORM_VAL"
                 
                 if [[ "$PLATFORM_VAL" == *"/"* ]]; then
                    SKOPEO_OS=$(echo "$PLATFORM_VAL" | awk -F'/' '{print $1}')
                    SKOPEO_ARCH=$(echo "$PLATFORM_VAL" | awk -F'/' '{print $2}')
                 else
                    SKOPEO_ARCH="$PLATFORM_VAL"
                 fi
              fi
            fi
            
            SKOPEO_FLAGS="--override-os $SKOPEO_OS --override-arch $SKOPEO_ARCH"

            SRC_IMAGE=$(echo "$line" | awk '{print $NF}')
            
            # 2. å‘½åå¤„ç†
            SCOPE=$(echo "$SRC_IMAGE" | awk -F'/' '{if (NF>2) print $(NF-1); else if (NF==2 && $1!="library") print $1; else print ""}')
            BASE_NAME=$(echo "$SRC_IMAGE" | awk -F'/' '{print $NF}')
            
            if [ -n "$SCOPE" ]; then
               TARGET_TAG="${SCOPE}_${BASE_NAME}"
            else
               TARGET_TAG="${BASE_NAME}"
            fi
            
            if [ -n "$PLATFORM_VAL" ]; then
               PLATFORM_TAG=$(echo "$PLATFORM_VAL" | sed 's/\//_/g')
               TARGET_TAG="${PLATFORM_TAG}_${TARGET_TAG}"
            fi

            ALI_TARGET="$ALIYUN_REGISTRY/$ALIYUN_NAMESPACE/$TARGET_TAG"
            
            # 3. æ‘˜è¦æ¯”å¯¹
            FORCE="${{ inputs.force_sync }}"
            NEED_PULL=true

            if [ "$FORCE" == "false" ]; then
               echo "ğŸ” æ¯”å¯¹ Digest ($SKOPEO_ARCH)..."
               SRC_DIGEST=$(skopeo inspect $SKOPEO_FLAGS docker://$SRC_IMAGE --format='{{.Digest}}' 2>/dev/null || echo "")
               DEST_DIGEST=$(skopeo inspect $SKOPEO_FLAGS docker://$ALI_TARGET --format='{{.Digest}}' 2>/dev/null || echo "")
               
               if [ -n "$SRC_DIGEST" ] && [ "$SRC_DIGEST" == "$DEST_DIGEST" ]; then
                  echo "âœ… é•œåƒæœ€æ–°ï¼Œè·³è¿‡ã€‚"
                  NEED_PULL=false
               else
                  echo "ğŸš€ éœ€è¦åŒæ­¥ã€‚"
               fi
            else
               echo "âš ï¸ å¼ºåˆ¶åŒæ­¥ã€‚"
            fi

            # 4. æ‰§è¡Œ
            if [ "$NEED_PULL" == "true" ]; then
               echo "ğŸ“¥ æ‹‰å–..."
               docker pull $SRC_IMAGE $PLATFORM_ARG
               
               echo "ğŸ“¤ æ¨é€ $ALI_TARGET ..."
               docker tag $SRC_IMAGE $ALI_TARGET
               docker push $ALI_TARGET
               
               echo "ğŸ§¹ æ¸…ç†..."
               docker rmi $SRC_IMAGE $ALI_TARGET || true
            fi
            
            df -h | grep "/var/lib/docker" || true

          done < images.txt
