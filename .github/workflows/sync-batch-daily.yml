name: æ‰¹é‡åŒæ­¥ (Batch Sync)

on:
  schedule:
    - cron: "0 0 1,15 * *"
  workflow_dispatch:
    inputs:
      force_sync:
        description: "å¼ºåˆ¶åŒæ­¥ (è·³è¿‡æ‘˜è¦æ¯”å¯¹)"
        required: false
        type: boolean
        default: false

env:
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}

jobs:
  batch-sync:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—‘ï¸ æ¸…ç†ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"
          build-mount-path: "/var/lib/docker/"

      - name: é‡å¯ Docker æœåŠ¡
        run: sudo service docker restart

      - name: Checkout Code
        uses: actions/checkout@v3

      - name: ç™»å½•é˜¿é‡Œäº‘ ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: ç™»å½• DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: ğŸ“¦ æ‰¹é‡å¤„ç†é•œåƒ
        run: |
          # å®šä¹‰é‡è¯•å‡½æ•°
          function retry {
            local n=1
            local max=3
            local delay=5
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "âš ï¸ å‘½ä»¤å¤±è´¥ï¼Œå¿è¯•ç¬¬ $n/$max æ¬¡é‡è¯•..."
                  sleep $delay;
                else
                  echo "âŒ å‘½ä»¤åœ¨ $max æ¬¡å°è¯•åå¤±è´¥ã€‚"
                  return 1
                fi
              }
            done
          }

          if [ ! -f "images.txt" ]; then
            echo "âŒ images.txt ä¸å­˜åœ¨ã€‚"
            exit 0
          fi

          echo "ğŸ“‹ å¼€å§‹æ‰¹é‡å¤„ç†..."

          while IFS= read -r line || [ -n "$line" ]; do
            # å»é™¤é¦–å°¾ç©ºç™½
            line=$(echo "$line" | xargs)
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$line" || "$line" =~ ^# ]] && continue

            echo "----------------------------------------"
            echo "ğŸ”„ å¤„ç†æŒ‡ä»¤: $line"

            # 1. è§£æå‚æ•°
            PLATFORM_ARG=""
            SKOPEO_OS="linux"
            SKOPEO_ARCH="amd64"
            
            # ä½¿ç”¨æ›´å¥å£®çš„æ­£åˆ™åŒ¹é… platform
            if [[ "$line" =~ --platform[=\ ]([^ ]+) ]]; then
              PLATFORM_VAL="${BASH_REMATCH[1]}"
              PLATFORM_ARG="--platform $PLATFORM_VAL"
              echo "âš™ï¸  æŒ‡å®šæ¶æ„: $PLATFORM_VAL"
                 
              if [[ "$PLATFORM_VAL" == *"/"* ]]; then
                SKOPEO_OS=$(echo "$PLATFORM_VAL" | cut -d'/' -f1)
                SKOPEO_ARCH=$(echo "$PLATFORM_VAL" | cut -d'/' -f2)
              else
                SKOPEO_ARCH="$PLATFORM_VAL"
              fi
            fi
            
            SKOPEO_FLAGS="--override-os $SKOPEO_OS --override-arch $SKOPEO_ARCH"

            # æå–é•œåƒåï¼ˆç§»é™¤å‚æ•°éƒ¨åˆ†ï¼‰
            SRC_IMAGE=$(echo "$line" | awk '{print $NF}')
            
            # 2. å‘½åå¤„ç† (Smart Naming)
            # æå– Scope (namespace) å’Œ Basename
            # Logic: bitnami/redis -> Scope: bitnami, Base: redis
            #        redis -> Scope: "", Base: redis
            #        library/redis -> Scope: "", Base: redis
            
            SCOPE=""
            BASE_NAME=$(basename "$SRC_IMAGE" | cut -d':' -f1)
            TAG_NAME=$(echo "$SRC_IMAGE" | cut -d':' -f2 -s)
            [ -z "$TAG_NAME" ] && TAG_NAME="latest"
            
            # ç®€å•è§£æ namespace
            if [[ "$SRC_IMAGE" == *"/"* ]]; then
                NAMESPACE_PART=$(dirname "$SRC_IMAGE")
                if [[ "$NAMESPACE_PART" != "library" && "$NAMESPACE_PART" != "." ]]; then
                   SCOPE=$(basename "$NAMESPACE_PART")
                fi
            fi
            
            if [ -n "$SCOPE" ]; then
               TARGET_TAG="${SCOPE}_${BASE_NAME}:${TAG_NAME}"
            else
               TARGET_TAG="${BASE_NAME}:${TAG_NAME}"
            fi
            
            # å¤šæ¶æ„å‰ç¼€è¿½åŠ 
            if [ -n "$PLATFORM_VAL" ]; then
               PLATFORM_PREFIX=$(echo "$PLATFORM_VAL" | sed 's/\//_/g')
               TARGET_TAG="${PLATFORM_PREFIX}_${TARGET_TAG}"
            fi

            ALI_TARGET="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/$TARGET_TAG"
            
            # 3. æ‘˜è¦æ¯”å¯¹
            FORCE="${{ inputs.force_sync }}"
            NEED_PULL=true

            if [ "$FORCE" != "true" ]; then
               echo "ğŸ” æ¯”å¯¹ Digest ($SKOPEO_ARCH)..."
               # å¢åŠ ç‰¹å®š retry é¿å…ç½‘ç»œæŠ–åŠ¨è¯¯åˆ¤
               SRC_DIGEST=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$SRC_IMAGE" --format='{{.Digest}}' 2>/dev/null || echo "")
               DEST_DIGEST=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$ALI_TARGET" --format='{{.Digest}}' 2>/dev/null || echo "")
               
               if [ -n "$SRC_DIGEST" ] && [ "$SRC_DIGEST" == "$DEST_DIGEST" ]; then
                  echo "âœ… é•œåƒä¸æºç«¯ä¸€è‡´ ($SRC_DIGEST)ï¼Œè·³è¿‡ã€‚"
                  NEED_PULL=false
               else
                  if [ -z "$SRC_DIGEST" ]; then
                    echo "âš ï¸ æ— æ³•è·å–æºé•œåƒæ‘˜è¦ï¼Œå¯èƒ½ä¸å­˜åœ¨æˆ–ç½‘ç»œé—®é¢˜ã€‚"
                  fi
                  echo "ğŸš€ æ‘˜è¦ä¸ä¸€è‡´æˆ–ç›®æ ‡ä¸å­˜åœ¨ï¼Œå‡†å¤‡åŒæ­¥ã€‚"
               fi
            else
               echo "âš ï¸ å¼ºåˆ¶æ¨¡å¼ï¼Œè·³è¿‡æ¯”å¯¹ã€‚"
            fi

            # 4. æ‰§è¡ŒåŒæ­¥
            if [ "$NEED_PULL" == "true" ]; then
               echo "ğŸ“¥ æ‹‰å– $SRC_IMAGE ..."
               retry docker pull $SRC_IMAGE $PLATFORM_ARG
               
               echo "ğŸ·ï¸ æ‰“æ ‡ç­¾ -> $ALI_TARGET"
               docker tag "$SRC_IMAGE" "$ALI_TARGET"
               
               echo "ğŸ“¤ æ¨é€ $ALI_TARGET ..."
               retry docker push "$ALI_TARGET"
               
               echo "ğŸ§¹åœ¨æ­¤æ¸…ç† ..."
               docker rmi "$SRC_IMAGE" "$ALI_TARGET" >/dev/null 2>&1 || true
            fi
            
            # ç®€å•ç›‘æ§
            echo "ç£ç›˜ç©ºé—´:"
            df -h | grep "/var/lib/docker" | awk '{print $4 " available"}' || true

          done < images.txt
