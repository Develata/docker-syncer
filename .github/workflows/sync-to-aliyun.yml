name: 搬运镜像到阿里云 (Manual)

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: '原镜像名称 (例如: mysql:8.0)'
        required: true
        default: 'nginx:alpine'
      new_name:
        description: '保存名称 (留空则自动处理，支持 bitnami/nginx -> bitnami_nginx)'
        required: false
        default: ''
      platform:
        description: '指定架构 (例如: linux/arm64，留空默认 amd64)'
        required: false
        default: ''
      force_sync:
        description: '强制同步 (跳过摘要比对)'
        type: boolean
        required: false
        default: false

jobs:
  push-to-aliyun:
    runs-on: ubuntu-latest
    steps:
      - name: 登录阿里云 ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: 执行同步
        run: |
          # 1. 变量准备
          SRC_IMAGE="${{ inputs.image_name }}"
          PLATFORM_ARG=""
          if [ -n "${{ inputs.platform }}" ]; then
            PLATFORM_ARG="--platform ${{ inputs.platform }}"
            echo "⚙️ 指定架构: ${{ inputs.platform }}"
          fi

          # 2. 目标名称计算 (智能前缀)
          if [ -n "${{ inputs.new_name }}" ]; then
            TARGET_TAG="${{ inputs.new_name }}"
          else
             # 提取命名空间
             SCOPE=$(echo "$SRC_IMAGE" | awk -F'/' '{if (NF>2) print $(NF-1); else if (NF==2 && $1!="library") print $1; else print ""}')
             BASE_NAME=$(echo "$SRC_IMAGE" | awk -F'/' '{print $NF}')
             
             if [ -n "$SCOPE" ]; then
                TARGET_TAG="${SCOPE}_${BASE_NAME}"
             else
                TARGET_TAG="${BASE_NAME}"
             fi
             
             # 如果是多架构，建议加前缀
             if [ -n "${{ inputs.platform }}" ]; then
                PLAT_PREFIX=$(echo "${{ inputs.platform }}" | sed 's/\//_/g')
                TARGET_TAG="${PLAT_PREFIX}_${TARGET_TAG}"
             fi
          fi

          ALI_TARGET="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/$TARGET_TAG"

          # 3. 摘要比对
          NEED_SYNC=true
          if [ "${{ inputs.force_sync }}" == "false" ]; then
             echo "🔍 检查 Digest..."
             SRC_DIGEST=$(skopeo inspect docker://$SRC_IMAGE --format='{{.Digest}}' 2>/dev/null || echo "")
             DEST_DIGEST=$(skopeo inspect docker://$ALI_TARGET --format='{{.Digest}}' 2>/dev/null || echo "")
             
             if [ -n "$SRC_DIGEST" ] && [ "$SRC_DIGEST" == "$DEST_DIGEST" ]; then
                echo "✅ 摘要一致 ($SRC_DIGEST)，无需同步。"
                NEED_SYNC=false
             fi
          fi

          # 4. 拉取与推送
          if [ "$NEED_SYNC" == "true" ]; then
             echo "📥 Pulling $SRC_IMAGE ..."
             docker pull $SRC_IMAGE $PLATFORM_ARG
             
             echo "🏷️ Tagging as $ALI_TARGET ..."
             docker tag $SRC_IMAGE $ALI_TARGET
             
             echo "📤 Pushing ..."
             docker push $ALI_TARGET
             
             echo "✅ 成功! 国内地址: $ALI_TARGET"
          fi
