env:
  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "åŸé•œåƒåç§° (ä¾‹å¦‚: mysql:8.0)"
        required: true
        default: "nginx:alpine"
      new_name:
        description: "ä¿å­˜åç§° (ç•™ç©ºåˆ™è‡ªåŠ¨å¤„ç†)"
        required: false
        default: ""
      platform:
        description: "æŒ‡å®šæ¶æ„ (ä¾‹å¦‚: linux/arm64ï¼Œç•™ç©ºé»˜è®¤ amd64)"
        required: false
        default: ""
      force_sync:
        description: "å¼ºåˆ¶åŒæ­¥ (è·³è¿‡æ‘˜è¦æ¯”å¯¹)"
        type: boolean
        required: false
        default: false

jobs:
  push-to-aliyun:
    runs-on: ubuntu-latest
    steps:
      # 1. ç©ºé—´æ¸…ç†
      - name: ğŸ—‘ï¸ æ¸…ç†ç£ç›˜ç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          build-mount-path: "/var/lib/docker/"

      - name: é‡å¯ Docker
        run: sudo service docker restart

      - name: æ£€æŸ¥ Secrets
        run: |
          if [ -z "${{ secrets.ALIYUN_USERNAME }}" ] || [ -z "${{ secrets.ALIYUN_PASSWORD }}" ]; then
            echo "âŒ é”™è¯¯: æœªé…ç½® ALIYUN_USERNAME æˆ– ALIYUN_PASSWORDSecretsã€‚"
            echo "è¯·åœ¨ Settings -> Secrets and variables -> Actions ä¸­é…ç½®ã€‚"
            exit 1
          fi

      - name: ç™»å½•é˜¿é‡Œäº‘ ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: æ‰§è¡ŒåŒæ­¥
        env:
          INPUT_IMAGE: ${{ inputs.image_name }}
          INPUT_NEW_NAME: ${{ inputs.new_name }}
          INPUT_PLATFORM: ${{ inputs.platform }}
          INPUT_FORCE: ${{ inputs.force_sync }}
        run: |
          # Define retry function
          function retry {
            local n=1
            local max=3
            local delay=5
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "âš ï¸ Command failed. Attempt $n/$max:"
                  sleep $delay;
                else
                  echo "âŒ The command has failed after $max attempts."
                  return 1
                fi
              }
            done
          }

          # 1. å˜é‡å‡†å¤‡
          SRC_IMAGE="$INPUT_IMAGE"
          PLATFORM_ARG=""
          SKOPEO_OS="linux"
          SKOPEO_ARCH="amd64"

          if [ -n "$INPUT_PLATFORM" ]; then
            PLATFORM_ARG="--platform $INPUT_PLATFORM"
            echo "âš™ï¸ æŒ‡å®šæ¶æ„: $INPUT_PLATFORM"
            
            if [[ "$INPUT_PLATFORM" == *"/"* ]]; then
               SKOPEO_OS=$(echo "$INPUT_PLATFORM" | awk -F'/' '{print $1}')
               SKOPEO_ARCH=$(echo "$INPUT_PLATFORM" | awk -F'/' '{print $2}')
            else
               SKOPEO_ARCH="$INPUT_PLATFORM"
            fi
          fi

          SKOPEO_FLAGS="--override-os $SKOPEO_OS --override-arch $SKOPEO_ARCH"

          # 2. ç›®æ ‡åç§°è®¡ç®—
          if [ -n "$INPUT_NEW_NAME" ]; then
            TARGET_TAG="$INPUT_NEW_NAME"
          else
             SCOPE=$(echo "$SRC_IMAGE" | awk -F'/' '{if (NF>2) print $(NF-1); else if (NF==2 && $1!="library") print $1; else print ""}')
             BASE_NAME=$(echo "$SRC_IMAGE" | awk -F'/' '{print $NF}')
             
             if [ -n "$SCOPE" ]; then
                TARGET_TAG="${SCOPE}_${BASE_NAME}"
             else
                TARGET_TAG="${BASE_NAME}"
             fi
             
             if [ -n "$INPUT_PLATFORM" ]; then
                PLAT_PREFIX=$(echo "$INPUT_PLATFORM" | sed 's/\//_/g')
                TARGET_TAG="${PLAT_PREFIX}_${TARGET_TAG}"
             fi
          fi

          ALI_TARGET="$ALIYUN_REGISTRY/$ALIYUN_NAMESPACE/$TARGET_TAG"

          # 3. æ‘˜è¦æ¯”å¯¹
          NEED_SYNC=true
          if [ "$INPUT_FORCE" == "false" ]; then
             echo "ğŸ” æ£€æŸ¥ Digest..."
             SRC_DIGEST=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$SRC_IMAGE" --format='{{.Digest}}' 2>/dev/null || echo "")
             DEST_DIGEST=$(retry skopeo inspect $SKOPEO_FLAGS "docker://$ALI_TARGET" --format='{{.Digest}}' 2>/dev/null || echo "")
             
             if [ -n "$SRC_DIGEST" ] && [ "$SRC_DIGEST" == "$DEST_DIGEST" ]; then
                echo "âœ… æ‘˜è¦ä¸€è‡´ ($SRC_DIGEST)ï¼Œæ— éœ€åŒæ­¥ã€‚"
                NEED_SYNC=false
             fi
          fi

          # 4. æ‹‰å–ä¸æ¨é€
          if [ "$NEED_SYNC" == "true" ]; then
             echo "ğŸ“¥ Pulling $SRC_IMAGE ..."
             retry docker pull "$SRC_IMAGE" $PLATFORM_ARG
             
             echo "ğŸ·ï¸ Tagging as $ALI_TARGET ..."
             docker tag $SRC_IMAGE $ALI_TARGET
             
             echo "ğŸ“¤ Pushing ..."
             retry docker push "$ALI_TARGET"
             
             echo "ğŸ§¹ Cleaning ..."
             docker rmi $SRC_IMAGE $ALI_TARGET || true
             
             echo "âœ… æˆåŠŸ! å›½å†…åœ°å€: $ALI_TARGET"
          fi

      - name: å‘é€ Webhook é€šçŸ¥
        if: always()
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            exit 0
          fi

          if [ "${{ job.status }}" == "success" ]; then
             TITLE="âœ… é˜¿é‡Œäº‘åŒæ­¥æˆåŠŸ"
          else
             TITLE="âŒ é˜¿é‡Œäº‘åŒæ­¥å¤±è´¥"
          fi

          PAYLOAD=$(cat <<EOF
          {
            "msg_type": "text",
            "content": {
              "text": "$TITLE\né•œåƒ: ${{ inputs.image_name }}\nçŠ¶æ€: ${{ job.status }}\né“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
          }
          EOF
          )

          curl -H "Content-Type: application/json" -d "$PAYLOAD" "$WEBHOOK_URL" || true
