name: 镜像搬运工 (DockerHub -> GHCR)

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: '原镜像名称 (例如: mysql:8.0)'
        required: true
        default: 'nginx:alpine'
      target_name:
        description: '保存名称 (可选，留空则保持原名)'
        required: false

env:
  REGISTRY: ghcr.io

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # 必须权限

    steps:
      # 1. (可选) 登录 DockerHub —— 防止拉取时被限流
      # 如果你不需要，可以删除这一步，但保留着更稳
      - name: 登录 DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        # 如果没有配置 Secrets，这一步会跳过或报错；
        # 即使报错，只要不是"required"，通常不影响后续，建议去 Secrets 配个免费号
        continue-on-error: true 

      # 2. 登录 GHCR
      - name: 登录 GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. 核心逻辑
      - name: 拉取、重命名并推送
        run: |
          # --- 变量准备 ---
          SRC_IMAGE="${{ inputs.image_name }}"
          
          # 判断是否自定义了名称
          if [ -z "${{ inputs.target_name }}" ]; then
            # 提取原镜像名 (例如: library/nginx:alpine -> nginx:alpine)
            IMAGE_TAG=$(echo "$SRC_IMAGE" | awk -F'/' '{print $NF}')
          else
            IMAGE_TAG="${{ inputs.target_name }}"
          fi

          # 组合基础地址
          # 技巧: 直接在这里把整个字符串转为小写，一劳永逸
          FULL_TARGET="${{ env.REGISTRY }}/${{ github.repository_owner }}/$IMAGE_TAG"
          TARGET_IMAGE=$(echo "$FULL_TARGET" | tr '[:upper:]' '[:lower:]')

          # --- 执行命令 ---
          echo "1️⃣ 正在从 DockerHub 拉取: $SRC_IMAGE"
          docker pull $SRC_IMAGE

          echo "2️⃣ 正在打标签: $TARGET_IMAGE"
          docker tag $SRC_IMAGE $TARGET_IMAGE

          echo "3️⃣ 正在推送到 GHCR..."
          docker push $TARGET_IMAGE

          echo "✅ 完成! 你的拉取地址是:"
          echo "docker pull $TARGET_IMAGE"
